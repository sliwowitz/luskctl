# syntax=docker/dockerfile:1
ARG BASE_IMAGE=codexctl-l0:latest
FROM ${BASE_IMAGE}

ENV HOST="0.0.0.0" \
    PORT="7860" \
    CODEXUI_DIR="/opt/codexui" \
    CODEXUI_DIST_URL="https://github.com/sliwowitz/codex-in-podman/releases/download/latest/codexui-dist.tar.gz"

USER root
RUN apt-get update && apt-get install -y --no-install-recommends \
      ssh ca-certificates python-is-python3 python3 nodejs npm curl \
    && rm -rf /var/lib/apt/lists/*

RUN set -eux; \
    printf '%s\n' \
      'alias codex="GIT_AUTHOR_NAME=Codex GIT_AUTHOR_EMAIL=codex@openai.com GIT_COMMITTER_NAME=\"\${HUMAN_GIT_NAME:-Nobody}\" GIT_COMMITTER_EMAIL=\"\${HUMAN_GIT_EMAIL:-nobody@localhost}\" codex --dangerously-bypass-approvals-and-sandbox"' \
      'alias claude="GIT_AUTHOR_NAME=Claude GIT_AUTHOR_EMAIL=noreply@anthropic.com GIT_COMMITTER_NAME=\"\${HUMAN_GIT_NAME:-Nobody}\" GIT_COMMITTER_EMAIL=\"\${HUMAN_GIT_EMAIL:-nobody@localhost}\" claude --dangerously-skip-permissions"' \
      > /etc/profile.d/codexctl-agent-aliases.sh; \
    if [ -f /etc/bash.bashrc ]; then \
      printf '\n# codexctl agent aliases\n. /etc/profile.d/codexctl-agent-aliases.sh\n' >> /etc/bash.bashrc; \
    else \
      printf '# codexctl agent aliases\n. /etc/profile.d/codexctl-agent-aliases.sh\n' > /etc/bash.bashrc; \
    fi

RUN set -eux; \
    mkdir -p /opt/codexui; \
    chown -R dev:dev /opt/codexui

COPY scripts/codexui-entry.sh /usr/local/bin/codexui-entry.sh
RUN chmod +x /usr/local/bin/codexui-entry.sh

EXPOSE 7860
USER dev
CMD ["codexui-entry.sh"]
