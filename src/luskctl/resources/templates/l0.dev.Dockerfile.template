# syntax=docker/dockerfile:1
ARG BASE_IMAGE=ubuntu:24.04
FROM ${BASE_IMAGE}

ENV DEBIAN_FRONTEND=noninteractive \
    REPO_ROOT="/workspace" \
    GIT_RESET_MODE="none" \
    USER="dev"

# Basic dev tooling common to all projects
RUN apt-get update && apt-get install -y --no-install-recommends \
      ca-certificates curl gnupg git openssh-client sudo \
      ripgrep vim \
    && rm -rf /var/lib/apt/lists/*

RUN set -eux; \
    uid_owner="$(getent passwd 1000 | cut -d: -f1 || true)"; \
    if [ -n "$uid_owner" ] && [ "$uid_owner" != "dev" ]; then \
      if getent group "$uid_owner" >/dev/null; then groupmod -n dev "$uid_owner" || true; fi; \
      usermod -l dev "$uid_owner"; \
      usermod -d /home/dev -m dev; \
    fi; \
    if ! getent group dev >/dev/null; then \
      groupadd dev; \
    fi; \
    if ! id -u dev >/dev/null 2>&1; then \
      useradd -m -u 1000 -g dev -s /bin/bash dev; \
    fi; \
    if [ "$(id -u dev)" != "1000" ]; then usermod -u 1000 dev; fi; \
    printf 'dev ALL=(ALL) NOPASSWD:ALL\n' > /etc/sudoers.d/dev; \
    chmod 0440 /etc/sudoers.d/dev; \
    mkdir -p /workspace /home/dev/.ssh; \
    chown -R dev:dev /home/dev /workspace; \
    chmod 700 /home/dev/.ssh; \
    chmod 0777 /workspace

WORKDIR /workspace

COPY scripts/init-ssh-and-repo.sh /usr/local/bin/init-ssh-and-repo.sh
RUN chmod +x /usr/local/bin/init-ssh-and-repo.sh

ENV HOME=/home/dev
USER dev
CMD ["init-ssh-and-repo.sh"]
