# syntax=docker/dockerfile:1
ARG BASE_IMAGE=luskctl-l0:latest
FROM ${BASE_IMAGE}

ARG LUSKUI_DIST_TAG=latest

ENV HOST="0.0.0.0" \
    PORT="7860" \
    LUSKUI_DIR="/opt/luskui" \
    LUSKUI_DIST_TAG="${LUSKUI_DIST_TAG}" \
    LUSKUI_DIST_URL="https://github.com/sliwowitz/luskui/releases/download/${LUSKUI_DIST_TAG}/luskui-dist.tar.gz"

# === Root operations ===
USER root
ENV HOME=/root

RUN apt-get update && apt-get install -y --no-install-recommends \
      ssh ca-certificates python-is-python3 python3 git nodejs curl \
    && rm -rf /var/lib/apt/lists/*

RUN set -eux; \
    printf '%s\n' \
      'alias codex="GIT_AUTHOR_NAME=Codex GIT_AUTHOR_EMAIL=codex@openai.com GIT_COMMITTER_NAME="\${HUMAN_GIT_NAME:-Nobody}" GIT_COMMITTER_EMAIL="\${HUMAN_GIT_EMAIL:-nobody@localhost}" codex --dangerously-bypass-approvals-and-sandbox"' \
      'alias claude="GIT_AUTHOR_NAME=Claude GIT_AUTHOR_EMAIL=noreply@anthropic.com GIT_COMMITTER_NAME="\${HUMAN_GIT_NAME:-Nobody}" GIT_COMMITTER_EMAIL="\${HUMAN_GIT_EMAIL:-nobody@localhost}" claude --dangerously-skip-permissions"' \
      > /etc/profile.d/luskctl-agent-aliases.sh; \
    if [ -f /etc/bash.bashrc ]; then \
      printf '\n# luskctl agent aliases\n. /etc/profile.d/luskctl-agent-aliases.sh\n' >> /etc/bash.bashrc; \
    else \
      printf '# luskctl agent aliases\n. /etc/profile.d/luskctl-agent-aliases.sh\n' > /etc/bash.bashrc; \
    fi

RUN set -eux; \
    mkdir -p "${LUSKUI_DIR}"; \
    tarball_path="/tmp/luskui-dist.tar.gz"; \
    curl -fsSL "${LUSKUI_DIST_URL}" -o "${tarball_path}"; \
    if [ ! -s "${tarball_path}" ]; then \
      echo "!! failed to download LuskUI distribution (file is missing or empty): ${tarball_path}"; \
      exit 1; \
    fi; \
    if ! tar -tzf "${tarball_path}" >/dev/null 2>&1; then \
      echo "!! downloaded LuskUI archive appears to be corrupted or not a valid tar.gz: ${tarball_path}"; \
      exit 1; \
    fi; \
    tar -xzf "${tarball_path}" -C "${LUSKUI_DIR}"; \
    rm -f "${tarball_path}"; \
    if [ ! -f "${LUSKUI_DIR}/dist/server.js" ]; then \
      echo "!! no UI entrypoint found (expected dist/server.js)."; \
      exit 1; \
    fi; \
    chown -R dev:dev "${LUSKUI_DIR}"

COPY scripts/luskui-entry.sh /usr/local/bin/luskui-entry.sh
RUN chmod +x /usr/local/bin/luskui-entry.sh

EXPOSE 7860

# === User operations ===
ENV HOME=/home/dev
USER dev
CMD ["luskui-entry.sh"]