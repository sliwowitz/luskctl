# syntax=docker/dockerfile:1
ARG BASE_IMAGE=luskctl-l0:latest
FROM ${BASE_IMAGE}

ENV DEBIAN_FRONTEND=noninteractive \
    PIPX_HOME=/opt/pipx \
    PIPX_BIN_DIR=/usr/local/bin

# === Root operations ===
USER root
ENV HOME=/root

RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
            curl ca-certificates gnupg \
            python-is-python3 python3 python3-pip python3-venv pipx ; \
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash -; \
    apt-get install -y --no-install-recommends nodejs; \
    rm -rf /var/lib/apt/lists/*

# Install mistral-vibe and mistralai SDK using pipx as root, ensuring PATH is set up
RUN set -eux; \
    pipx install mistral-vibe; \
    pipx inject mistral-vibe mistralai

# Install GitHub CLI (gh) from official APT repository
RUN set -eux; \
    curl -sSL -o /tmp/githubcli-archive-keyring.gpg \
      "https://cli.github.com/packages/githubcli-archive-keyring.gpg"; \
    install -o root -g root -m 644 /tmp/githubcli-archive-keyring.gpg /etc/apt/keyrings/githubcli-archive-keyring.gpg; \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list; \
    apt-get update; \
    apt-get install -y --no-install-recommends gh; \
    rm -rf /var/lib/apt/lists/* /tmp/githubcli-archive-keyring.gpg

# Install GitLab CLI (glab) from official GitLab releases
RUN set -eux; \
    GLAB_VERSION=$(curl -sSL "https://gitlab.com/api/v4/projects/gitlab-org%2Fcli/releases/permalink/latest" \
      | grep -o '"tag_name":"v[^"]*"' | head -1 | sed 's/"tag_name":"v//;s/"//'); \
    ARCH=$(dpkg --print-architecture); \
    DEB_NAME="glab_${GLAB_VERSION}_linux_${ARCH}.deb"; \
    curl -sSL -o /tmp/glab.deb \
      "https://gitlab.com/gitlab-org/cli/-/releases/v${GLAB_VERSION}/downloads/${DEB_NAME}"; \
    curl -sSL -o /tmp/checksums.txt \
      "https://gitlab.com/gitlab-org/cli/-/releases/v${GLAB_VERSION}/downloads/checksums.txt"; \
    grep "  ${DEB_NAME}$" /tmp/checksums.txt | sed "s|${DEB_NAME}|/tmp/glab.deb|" | sha256sum -c -; \
    dpkg -i /tmp/glab.deb; \
    rm -f /tmp/glab.deb /tmp/checksums.txt

# Copy setup script for codex auth (port forwarding for OAuth callbacks)
COPY scripts/setup-codex-auth.sh /usr/local/bin/setup-codex-auth.sh
RUN chmod +x /usr/local/bin/setup-codex-auth.sh

# Copy blablador wrapper (OpenCode-based)
COPY scripts/blablador /usr/local/bin/blablador
COPY scripts/vibe-model-sync.sh /usr/local/bin/vibe-model-sync
COPY scripts/mistral-model-sync.py /usr/local/bin/mistral-model-sync.py
RUN chmod +x /usr/local/bin/blablador /usr/local/bin/vibe-model-sync /usr/local/bin/mistral-model-sync.py

# Configure shell aliases and PATH for agent CLIs
RUN set -eux; \
    printf '%s\n' \
      '# Add user-installed agent CLIs to PATH' \
      'export PATH="$HOME/.npm-packages/bin:$HOME/.local/bin:$HOME/.opencode/bin:$PATH"' \
      '' \
      'alias codex="GIT_AUTHOR_NAME=Codex GIT_AUTHOR_EMAIL=codex@openai.com GIT_COMMITTER_NAME="\${HUMAN_GIT_NAME:-Nobody}" GIT_COMMITTER_EMAIL="\${HUMAN_GIT_EMAIL:-nobody@localhost}" codex --dangerously-bypass-approvals-and-sandbox"' \
      'alias copilot="GIT_AUTHOR_NAME=\"GitHub Copilot\" GIT_AUTHOR_EMAIL=copilot@github.com GIT_COMMITTER_NAME=\"\${HUMAN_GIT_NAME:-Nobody}\" GIT_COMMITTER_EMAIL=\"\${HUMAN_GIT_EMAIL:-nobody@localhost}\" copilot"' \
      'alias vibe="GIT_AUTHOR_NAME=\"Mistral Vibe\" GIT_AUTHOR_EMAIL=vibe@mistral.ai GIT_COMMITTER_NAME=\"\${HUMAN_GIT_NAME:-Nobody}\" GIT_COMMITTER_EMAIL=\"\${HUMAN_GIT_EMAIL:-nobody@localhost}\" vibe --agent auto-approve"' \
      'alias blablador="GIT_AUTHOR_NAME=Blablador GIT_AUTHOR_EMAIL=blablador@helmholtz.de GIT_COMMITTER_NAME="\${HUMAN_GIT_NAME:-Nobody}" GIT_COMMITTER_EMAIL="\${HUMAN_GIT_EMAIL:-nobody@localhost}" blablador"' \
      'alias gh="GIT_AUTHOR_NAME=\"GitHub CLI\" GIT_AUTHOR_EMAIL=gh@github.com GIT_COMMITTER_NAME=\"\${HUMAN_GIT_NAME:-Nobody}\" GIT_COMMITTER_EMAIL=\"\${HUMAN_GIT_EMAIL:-nobody@localhost}\" gh"' \
      'alias glab="GIT_AUTHOR_NAME=\"GitLab CLI\" GIT_AUTHOR_EMAIL=glab@gitlab.com GIT_COMMITTER_NAME=\"\${HUMAN_GIT_NAME:-Nobody}\" GIT_COMMITTER_EMAIL=\"\${HUMAN_GIT_EMAIL:-nobody@localhost}\" glab"' \
      '' \
      '# Print available agents on interactive login' \
      'if [ -t 1 ] && [ -z "$_LUSKCTL_AGENTS_SHOWN" ]; then' \
      '  export _LUSKCTL_AGENTS_SHOWN=1' \
      '  printf "\\n\\033[1mAvailable AI agents:\\033[0m\\n"' \
      '  printf "  \\033[36mcodex\\033[0m     - OpenAI Codex CLI (auto-approve enabled)\\n"' \
      '  printf "  \\033[36mclaude\\033[0m    - Claude Code CLI (permissions skipped)\\n"' \
      '  printf "  \\033[36mcopilot\\033[0m   - GitHub Copilot CLI\\n"' \
      '  printf "  \\033[36mvibe\\033[0m      - Mistral Vibe CLI (auto-approve enabled)\\n"' \
      '  printf "  \\033[36mblablador\\033[0m - OpenCode with Helmholtz Blablador (full permissions)\\n"' \
      '  printf "\\n"' \
      'fi' \
      '' \
      '# Source luskctl project config (claude wrapper function)' \
      '[ -r /etc/profile.d/zz-luskctl-project.sh ] && . /etc/profile.d/zz-luskctl-project.sh' \
      > /etc/profile.d/luskctl-agent-aliases.sh; \
    if [ -f /etc/bash.bashrc ]; then \
      printf '\n# luskctl agent aliases\n. /etc/profile.d/luskctl-agent-aliases.sh\n' >> /etc/bash.bashrc; \
    else \
      printf '# luskctl agent aliases\n. /etc/profile.d/luskctl-agent-aliases.sh\n' > /etc/bash.bashrc; \
    fi; \
    # Add Mistral model sync to bashrc (only for interactive shells)
    printf '\n# Mistral model sync (checks for new models on login)\nif [ -t 1 ] && [ -z "$_MISTRAL_MODEL_SYNC_RUN" ]; then\n  export _MISTRAL_MODEL_SYNC_RUN=1\n  if command -v vibe-model-sync >/dev/null 2>&1; then\n    vibe-model-sync >/dev/null 2>&1 || true\n  fi\nfi\n' >> /etc/bash.bashrc

# Symlink for luskctl project config (resolved at runtime via mount).
RUN ln -s /home/dev/.luskctl/luskctl-claude.sh /etc/profile.d/zz-luskctl-project.sh

# === User operations ===
ENV HOME=/home/dev
ENV NPM_CONFIG_PREFIX=/home/dev/.npm-packages \
    PATH=/home/dev/.npm-packages/bin:/home/dev/.local/bin:/home/dev/.opencode/bin:$PATH
USER dev
WORKDIR /home/dev

# Cache bust point - changing AGENT_CACHE_BUST invalidates all layers below
# Used by `luskctl build --agents` to force fresh agent installs
ARG AGENT_CACHE_BUST=0

# Install AI agent CLIs as dev user
RUN mkdir -p "$NPM_CONFIG_PREFIX" && npm config set prefix "$NPM_CONFIG_PREFIX"
RUN npm install -g @openai/codex
RUN npm install -g @github/copilot
RUN curl -fsSL https://claude.ai/install.sh | bash
RUN curl -fsSL https://opencode.ai/install | bash
RUN npm cache clean --force

WORKDIR /workspace
# No CMD: reuse init-ssh-and-repo.sh from base image
