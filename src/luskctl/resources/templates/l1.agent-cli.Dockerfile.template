# syntax=docker/dockerfile:1
ARG BASE_IMAGE=luskctl-l0:latest
FROM ${BASE_IMAGE}

ENV DEBIAN_FRONTEND=noninteractive \
    PIPX_HOME=/opt/pipx \
    PIPX_BIN_DIR=/usr/local/bin

USER root
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
            curl ca-certificates gnupg \
            python-is-python3 python3 python3-pip python3-venv pipx ; \
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash -; \
    apt-get install -y --no-install-recommends nodejs; \
    npm install -g @openai/codex; \
    npm install -g @anthropic-ai/claude-code; \
    npm cache clean --force; \
    rm -rf /var/lib/apt/lists/*

# Install mistral-vibe and mistralai SDK using pipx as root, ensuring PATH is set up
RUN set -eux; \
    pipx install mistral-vibe; \
    pipx inject mistral-vibe mistralai

# Install OpenCode CLI (used by the Blablador wrapper)
RUN set -eux; \
    export OPENCODE_INSTALL_DIR=/usr/local/bin; \
    curl -fsSL https://opencode.ai/install | bash

# Copy setup script for codex auth (port forwarding for OAuth callbacks)
COPY scripts/setup-codex-auth.sh /usr/local/bin/setup-codex-auth.sh
RUN chmod +x /usr/local/bin/setup-codex-auth.sh

# Copy blablador wrapper (OpenCode-based)
COPY scripts/blablador /usr/local/bin/blablador
COPY scripts/vibe-model-sync.sh /usr/local/bin/vibe-model-sync
RUN chmod +x /usr/local/bin/blablador /usr/local/bin/vibe-model-sync

RUN set -eux; \
    printf '%s\n' \
      'alias codex="GIT_AUTHOR_NAME=Codex GIT_AUTHOR_EMAIL=codex@openai.com GIT_COMMITTER_NAME=\"\${HUMAN_GIT_NAME:-Nobody}\" GIT_COMMITTER_EMAIL=\"\${HUMAN_GIT_EMAIL:-nobody@localhost}\" codex --dangerously-bypass-approvals-and-sandbox"' \
      'alias claude="GIT_AUTHOR_NAME=Claude GIT_AUTHOR_EMAIL=noreply@anthropic.com GIT_COMMITTER_NAME=\"\${HUMAN_GIT_NAME:-Nobody}\" GIT_COMMITTER_EMAIL=\"\${HUMAN_GIT_EMAIL:-nobody@localhost}\" claude --dangerously-skip-permissions"' \
      'alias vibe="GIT_AUTHOR_NAME=\"Mistral Vibe\" GIT_AUTHOR_EMAIL=vibe@mistral.ai GIT_COMMITTER_NAME=\"\${HUMAN_GIT_NAME:-Nobody}\" GIT_COMMITTER_EMAIL=\"\${HUMAN_GIT_EMAIL:-nobody@localhost}\" vibe --auto-approve"' \
      '' \
      '# Print available agents on interactive login' \
      'if [ -t 1 ] && [ -z "$_LUSKCTL_AGENTS_SHOWN" ]; then' \
      '  export _LUSKCTL_AGENTS_SHOWN=1' \
      '  printf "\\n\\033[1mAvailable AI agents:\\033[0m\\n"' \
      '  printf "  \\033[36mcodex\\033[0m  - OpenAI Codex CLI (auto-approve enabled)\\n"' \
      '  printf "  \\033[36mclaude\\033[0m - Claude Code CLI (permissions skipped)\\n"' \
      '  printf "  \\033[36mvibe\\033[0m   - Mistral Vibe CLI (auto-approve enabled)\\n"' \
      '  printf "  \\033[36mblablador\\033[0m - OpenCode (Blablador) with full permissions (not yet implemented)\\n"' \
      '  printf "\\n"' \
      'fi' \
      > /etc/profile.d/luskctl-agent-aliases.sh; \
    if [ -f /etc/bash.bashrc ]; then \
      printf '\n# luskctl agent aliases\n. /etc/profile.d/luskctl-agent-aliases.sh\n' >> /etc/bash.bashrc; \
    else \
      printf '# luskctl agent aliases\n. /etc/profile.d/luskctl-agent-aliases.sh\n' > /etc/bash.bashrc; \
    fi; \
    # Add Mistral model sync to bashrc (only for interactive shells)
    printf '\n# Mistral model sync (checks for new models on login)\nif [ -t 1 ] && [ -z "$_MISTRAL_MODEL_SYNC_RUN" ]; then\n  export _MISTRAL_MODEL_SYNC_RUN=1\n  if command -v vibe-model-sync >/dev/null 2>&1; then\n    vibe-model-sync >/dev/null 2>&1 || true\n  fi\nfi\n' >> /etc/bash.bashrc

USER dev
# No CMD: reuse init-ssh-and-repo.sh from base image
