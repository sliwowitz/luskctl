#!/usr/bin/env python3
"""
OpenCode custom provider launcher.

Uses a pre-configured JSON file for custom providers and runs OpenCode
with complete unrestricted access to the container.
"""

import json
from pathlib import Path

# Import shared OpenCode functionality
import sys
import os

# Add the directory containing opencode_common.py to the path
script_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, script_dir)

try:
    from opencode_common import _write_opencode_config, _ensure_full_permissions, run_opencode
except ImportError as e:
    raise ImportError(f"Failed to import opencode_common: {e}") from e


def main() -> int:
    """Main entry point for opencode-custom."""
    # Load global config to get custom config path
    from luskctl.lib.config import load_global_config
    global_config = load_global_config()

    # Get custom config path
    custom_config_path = global_config.get("opencode", {}).get("custom_config_path")
    if not custom_config_path:
        raise SystemExit(
            "No custom OpenCode config path specified. "
            "Add to luskctl-config.yml under opencode.custom_config_path"
        )

    # Load the custom config file
    try:
        custom_config = json.loads(Path(custom_config_path).read_text())
    except (FileNotFoundError, json.JSONDecodeError) as e:
        raise SystemExit(f"Failed to load custom OpenCode config from {custom_config_path}: {e}")

    # Ensure full permissions and write config
    config = _ensure_full_permissions(custom_config)
    _write_opencode_config(config)

    # Run OpenCode
    return run_opencode()


if __name__ == "__main__":
    raise SystemExit(main())
