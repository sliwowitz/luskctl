from unittest import TestCase, main, mock

from tui_test_helpers import build_textual_stubs, import_fresh

from test_utils import make_staleness_info


class ProjectStateStalenessTests(TestCase):
    def test_staleness_checked_for_online_and_gatekeeping(self) -> None:
        stubs = build_textual_stubs()
        _, _, app = import_fresh(stubs)

        staleness = make_staleness_info(commits_behind=1)

        for security_class in ("online", "gatekeeping"):
            with self.subTest(security_class=security_class):
                project = mock.Mock()
                project.security_class = security_class
                project.upstream_url = "https://example.com/repo.git"

                state = {"gate": True}

                with mock.patch.object(app, "load_project", return_value=project):
                    with mock.patch.object(app, "get_project_state", return_value=state):
                        with mock.patch.object(
                            app, "compare_gate_vs_upstream", return_value=staleness
                        ) as compare:
                            result = app.LuskTUI._load_project_state(mock.Mock(), "proj1")
                            compare.assert_called_once_with("proj1")

                self.assertEqual(
                    result,
                    ("proj1", project, state, staleness, None),
                )


if __name__ == "__main__":
    main()
