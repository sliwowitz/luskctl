exclude = [
    "**/__pycache__",
    "**/tests/**",
    "build",
    "dist",
    ".venv",
    "docs",
    "examples",
    "tmp",
    "analyze_final_state.py",
]

source_roots = ["src"]
exact = false
forbid_circular_dependencies = true
ignore_type_checking_imports = true

# ── Layer Architecture ──────────────────────────────────────────────
#
#   presentation   CLI and TUI frontends (can depend on services + core)
#   services       Domain services / orchestrators (can depend on core)
#   core           Foundation types, config, and pure utilities
#
layers = [
    "presentation",
    "services",
    "core",
]

[external]
exclude = ["pydevd_pycharm", "pydevd"]

# ── PRESENTATION LAYER ──────────────────────────────────────────────

# CLI frontend
[[modules]]
path = "luskctl.cli"
layer = "presentation"
depends_on = [
    "luskctl.lib.containers.agent_config",
    "luskctl.lib.containers.headless_providers",
    "luskctl.lib.core.config",
    "luskctl.lib.core.projects",
    "luskctl.lib.core.version",
    "luskctl.lib.facade",
    "luskctl.lib.wizards.new_project",
    "luskctl.ui_utils.terminal",
]

# TUI frontend
[[modules]]
path = "luskctl.tui"
layer = "presentation"
depends_on = [
    "luskctl.lib.containers.agents",
    "luskctl.lib.containers.autopilot",
    "luskctl.lib.containers.headless_providers",
    "luskctl.lib.containers.runtime",
    "luskctl.lib.containers.task_display",
    "luskctl.lib.containers.tasks",
    "luskctl.lib.core.config",
    "luskctl.lib.core.projects",
    "luskctl.lib.core.version",
    "luskctl.lib.facade",
    "luskctl.lib.util.emoji",
]

# Service facade (aggregates shared cross-cutting operations)
[[modules]]
path = "luskctl.lib.facade"
layer = "services"
depends_on = [
    "luskctl.lib.containers.docker",
    "luskctl.lib.containers.environment",
    "luskctl.lib.containers.project_state",
    "luskctl.lib.containers.task_logs",
    "luskctl.lib.containers.task_runners",
    "luskctl.lib.containers.tasks",
    "luskctl.lib.core.projects",
    "luskctl.lib.security.auth",
    "luskctl.lib.security.git_gate",
    "luskctl.lib.security.ssh",
]

# ── SERVICES LAYER ──────────────────────────────────────────────────
#
# ·· containers ··  Task lifecycle, container runtime, Dockerfiles
#

# Agent configuration (parsing, filtering, wrapper generation)
[[modules]]
path = "luskctl.lib.containers.agents"
layer = "services"
depends_on = ["luskctl.lib.containers.headless_providers", "luskctl.lib.core.projects", "luskctl.lib.util.fs"]

# Headless provider registry (multi-agent autopilot support)
[[modules]]
path = "luskctl.lib.containers.headless_providers"
layer = "services"
depends_on = ["luskctl.lib.core.projects"]

# Agent config resolution (layered merging across scopes)
[[modules]]
path = "luskctl.lib.containers.agent_config"
layer = "services"
depends_on = ["luskctl.lib.util.config_stack", "luskctl.lib.core.config", "luskctl.lib.core.projects"]

# Autopilot container lifecycle (wait, logs)
[[modules]]
path = "luskctl.lib.containers.autopilot"
layer = "services"
depends_on = ["luskctl.lib.containers.tasks"]

# Agent log formatters (Claude stream-json, plain text)
[[modules]]
path = "luskctl.lib.containers.log_format"
layer = "services"
depends_on = ["luskctl.lib.util.ansi"]

# Task display types and status computation
[[modules]]
path = "luskctl.lib.containers.task_display"
layer = "services"
depends_on = []

# Task log viewing and streaming
[[modules]]
path = "luskctl.lib.containers.task_logs"
layer = "services"
depends_on = [
    "luskctl.lib.containers.log_format",
    "luskctl.lib.containers.runtime",
    "luskctl.lib.containers.tasks",
    "luskctl.lib.core.projects",
]

# Task metadata, lifecycle, and queries
[[modules]]
path = "luskctl.lib.containers.tasks"
layer = "services"
depends_on = [
    "luskctl.lib.containers.runtime",
    "luskctl.lib.containers.task_display",
    "luskctl.lib.core.config",
    "luskctl.lib.core.projects",
    "luskctl.lib.util.ansi",
    "luskctl.lib.util.emoji",
    "luskctl.lib.util.fs",
    "luskctl.lib.util.logging_utils",
]

# Task container runners (CLI, web, headless, restart)
[[modules]]
path = "luskctl.lib.containers.task_runners"
layer = "services"
depends_on = [
    "luskctl.lib.containers.agent_config",
    "luskctl.lib.containers.agents",
    "luskctl.lib.containers.environment",
    "luskctl.lib.containers.headless_providers",
    "luskctl.lib.containers.ports",
    "luskctl.lib.containers.runtime",
    "luskctl.lib.containers.tasks",
    "luskctl.lib.core.images",
    "luskctl.lib.core.projects",
    "luskctl.lib.util.ansi",
    "luskctl.lib.util.podman",
]

# Container state, GPU args, log streaming
[[modules]]
path = "luskctl.lib.containers.runtime"
layer = "services"
depends_on = ["luskctl.lib.core.projects", "luskctl.lib.util.logging_utils"]

# Task environment & volume mounts
[[modules]]
path = "luskctl.lib.containers.environment"
layer = "services"
depends_on = ["luskctl.lib.core.config", "luskctl.lib.core.projects", "luskctl.lib.util.fs"]

# Task port allocation
[[modules]]
path = "luskctl.lib.containers.ports"
layer = "services"
depends_on = ["luskctl.lib.core.config"]

# Dockerfile generation & image building
[[modules]]
path = "luskctl.lib.containers.docker"
layer = "services"
depends_on = ["luskctl.lib.core.config", "luskctl.lib.core.images", "luskctl.lib.core.projects", "luskctl.lib.util.fs"]

# Project infrastructure state (queries podman & filesystem)
[[modules]]
path = "luskctl.lib.containers.project_state"
layer = "services"
depends_on = [
    "luskctl.lib.containers.docker",
    "luskctl.lib.core.config",
    "luskctl.lib.core.images",
    "luskctl.lib.core.projects",
]

#
# ·· security ··  Auth, SSH, git gate
#

# API key authentication workflows
[[modules]]
path = "luskctl.lib.security.auth"
layer = "services"
depends_on = [
    "luskctl.lib.util.podman",
    "luskctl.lib.core.config",
    "luskctl.lib.core.images",
    "luskctl.lib.core.projects",
    "luskctl.lib.util.fs",
]

# SSH key management
[[modules]]
path = "luskctl.lib.security.ssh"
layer = "services"
depends_on = [
    "luskctl.lib.core.config",
    "luskctl.lib.core.projects",
    "luskctl.lib.util.fs",
    "luskctl.lib.util.template_utils",
]

# Git gate sync & validation
[[modules]]
path = "luskctl.lib.security.git_gate"
layer = "services"
depends_on = ["luskctl.lib.core.config", "luskctl.lib.core.projects"]

#
# ·· wizards ··  Interactive workflows
#

# Interactive project creation
[[modules]]
path = "luskctl.lib.wizards.new_project"
layer = "services"
depends_on = [
    "luskctl.lib.core.config",
    "luskctl.ui_utils.editor",
    "luskctl.lib.util.fs",
    "luskctl.lib.util.template_utils",
]

# ── CORE LAYER ──────────────────────────────────────────────────────
#
# ·· core ··  Foundation types & config
#

# Top-level package (version metadata only)
[[modules]]
path = "luskctl"
layer = "core"
depends_on = []

# Version info
[[modules]]
path = "luskctl.lib.core.version"
layer = "core"
depends_on = ["luskctl"]

# Path resolution (FHS/XDG)
[[modules]]
path = "luskctl.lib.core.paths"
layer = "core"
depends_on = []

# Configuration management
[[modules]]
path = "luskctl.lib.core.config"
layer = "core"
depends_on = ["luskctl.lib.core.paths"]

# Project and preset data models (pure types, no I/O)
[[modules]]
path = "luskctl.lib.core.project_model"
layer = "core"
depends_on = []

# Project discovery, loading, and preset management
[[modules]]
path = "luskctl.lib.core.projects"
layer = "core"
depends_on = ["luskctl.lib.core.config", "luskctl.lib.core.project_model", "luskctl.lib.util.config_stack"]

# Image naming conventions
[[modules]]
path = "luskctl.lib.core.images"
layer = "core"
depends_on = []

#
# ·· ui ··  Shared UI helpers (terminal, editor)
#

# Terminal ANSI formatting
[[modules]]
path = "luskctl.ui_utils.terminal"
layer = "core"
depends_on = ["luskctl.lib.util.ansi"]
utility = true

# $EDITOR launching
[[modules]]
path = "luskctl.ui_utils.editor"
layer = "core"
depends_on = []
utility = true

#
# ·· util ··  Pure internal helpers
#

# Podman user namespace handling
[[modules]]
path = "luskctl.lib.util.podman"
layer = "core"
depends_on = []
utility = true

# Filesystem helpers (mkdir, writable check)
[[modules]]
path = "luskctl.lib.util.fs"
layer = "core"
depends_on = []
utility = true

# Simple {{VAR}} template rendering
[[modules]]
path = "luskctl.lib.util.template_utils"
layer = "core"
depends_on = []
utility = true

# ANSI color utilities (used by services layer)
[[modules]]
path = "luskctl.lib.util.ansi"
layer = "core"
depends_on = []
utility = true

# Debug logging stub
[[modules]]
path = "luskctl.lib.util.logging_utils"
layer = "core"
depends_on = ["luskctl.lib.core.paths"]
utility = true

# Emoji display-width utilities
[[modules]]
path = "luskctl.lib.util.emoji"
layer = "core"
depends_on = []
utility = true

# Generic layered config resolution
[[modules]]
path = "luskctl.lib.util.config_stack"
layer = "core"
depends_on = []
utility = true

# ── Interfaces ──────────────────────────────────────────────────────

[[interfaces]]
expose = [
    "Project",
    "PresetInfo",
    "effective_ssh_key_name",
    "validate_project_id",
]
from = ["luskctl.lib.core.project_model"]

[[interfaces]]
expose = [
    "Project",
    "PresetInfo",
    "find_preset_path",
    "list_projects",
    "load_project",
    "load_preset",
    "list_presets",
    "derive_project",
    "effective_ssh_key_name",
    "validate_project_id",
]
from = ["luskctl.lib.core.projects"]

[[interfaces]]
expose = [
    "StatusInfo",
    "ModeInfo",
    "STATUS_DISPLAY",
    "MODE_DISPLAY",
    "WEB_BACKEND_EMOJI",
    "WEB_BACKEND_DEFAULT_EMOJI",
    "effective_status",
    "mode_emoji",
]
from = ["luskctl.lib.containers.task_display"]

[[interfaces]]
expose = ["task_logs"]
from = ["luskctl.lib.containers.task_logs"]

[[interfaces]]
expose = [
    "task_new",
    "task_rename",
    "task_stop",
    "task_delete",
    "task_login",
    "task_list",
    "task_status",
    "get_tasks",
    "get_all_task_states",
    "get_login_command",
    "get_workspace_git_diff",
    "mark_task_deleting",
    "update_task_exit_code",
    "load_task_meta",
    "sanitize_task_name",
    "validate_task_name",
    "generate_task_name",
    "TASK_NAME_MAX_LEN",
    "TaskMeta",
    "tasks_meta_dir",
]
from = ["luskctl.lib.containers.tasks"]

[[interfaces]]
expose = ["task_run_cli", "task_run_web", "task_run_headless", "task_restart", "task_followup_headless"]
from = ["luskctl.lib.containers.task_runners"]

[[interfaces]]
expose = ["parse_md_agent", "prepare_agent_config_dir"]
from = ["luskctl.lib.containers.agents"]

[[interfaces]]
expose = ["HeadlessProvider", "HEADLESS_PROVIDERS", "PROVIDER_NAMES", "get_provider", "build_headless_command", "generate_agent_wrapper"]
from = ["luskctl.lib.containers.headless_providers"]

[[interfaces]]
expose = ["build_agent_config_stack", "resolve_agent_config"]
from = ["luskctl.lib.containers.agent_config"]

[[interfaces]]
expose = ["AUTH_PROVIDERS", "AuthProvider", "authenticate"]
from = ["luskctl.lib.security.auth"]

[[interfaces]]
expose = [
    "generate_dockerfiles",
    "build_images",
    "build_context_hash",
    "dockerfiles_match_templates",
]
from = ["luskctl.lib.containers.docker"]

[[interfaces]]
expose = ["init_project_ssh"]
from = ["luskctl.lib.security.ssh"]

[[interfaces]]
expose = [
    "sync_project_gate",
    "compare_gate_vs_upstream",
    "sync_gate_branches",
    "GateStalenessInfo",
    "find_projects_sharing_gate",
    "get_gate_last_commit",
]
from = ["luskctl.lib.security.git_gate"]

[[interfaces]]
expose = ["get_project_state", "is_task_image_old"]
from = ["luskctl.lib.containers.project_state"]

# Core module interfaces

[[interfaces]]
expose = [
    "config_root",
    "state_root",
    "build_root",
    "user_projects_root",
    "global_presets_dir",
    "bundled_presets_dir",
    "get_envs_base_dir",
    "get_logs_partial_streaming",
    "get_ui_base_port",
    "get_tui_default_tmux",
    "get_global_human_name",
    "get_global_human_email",
    "get_global_default_agent",
    "global_config_path",
    "global_config_search_paths",
    "load_global_config",
    "get_global_section",
    "get_global_agent_config",
    "get_task_name_categories",
    "get_prefix",
]
from = ["luskctl.lib.core.config"]

[[interfaces]]
expose = [
    "base_dev_image",
    "agent_cli_image",
    "agent_ui_image",
    "project_cli_image",
    "project_web_image",
    "project_dev_image",
]
from = ["luskctl.lib.core.images"]

# Service module interfaces

[[interfaces]]
expose = [
    "WEB_BACKENDS",
    "SHARED_MOUNTS",
    "SharedMount",
    "build_task_env_and_volumes",
    "apply_web_env_overrides",
]
from = ["luskctl.lib.containers.environment"]

[[interfaces]]
expose = [
    "container_name",
    "get_task_container_state",
    "get_container_state",
    "gpu_run_args",
    "is_container_running",
    "stop_task_containers",
    "stream_initial_logs",
    "wait_for_exit",
    "get_project_container_states",
]
from = ["luskctl.lib.containers.runtime"]

[[interfaces]]
expose = ["auto_detect_formatter", "ClaudeStreamJsonFormatter", "PlainTextFormatter"]
from = ["luskctl.lib.containers.log_format"]

[[interfaces]]
expose = ["wait_for_container_exit", "follow_container_logs_cmd"]
from = ["luskctl.lib.containers.autopilot"]

[[interfaces]]
expose = ["run_wizard", "collect_wizard_inputs", "generate_config"]
from = ["luskctl.lib.wizards.new_project"]

[[interfaces]]
expose = [
    "generate_dockerfiles",
    "build_images",
    "WEB_BACKENDS",
    "task_new",
    "task_delete",
    "task_rename",
    "task_login",
    "task_list",
    "task_status",
    "task_stop",
    "get_tasks",
    "task_run_cli",
    "task_run_web",
    "task_run_headless",
    "task_restart",
    "task_followup_headless",
    "task_logs",
    "init_project_ssh",
    "sync_project_gate",
    "AUTH_PROVIDERS",
    "AuthProvider",
    "authenticate",
    "compare_gate_vs_upstream",
    "sync_gate_branches",
    "get_gate_last_commit",
    "GateStalenessInfo",
    "find_projects_sharing_gate",
    "get_project_state",
    "is_task_image_old",
    "maybe_pause_for_ssh_key_registration",
]
from = ["luskctl.lib.facade"]

# Config stack utility interface
[[interfaces]]
expose = ["deep_merge", "ConfigScope", "ConfigStack", "load_yaml_scope", "load_json_scope"]
from = ["luskctl.lib.util.config_stack"]

# Emoji utility interface
[[interfaces]]
expose = ["draw_emoji"]
from = ["luskctl.lib.util.emoji"]

# Filesystem utility interface
[[interfaces]]
expose = ["ensure_dir", "ensure_dir_writable"]
from = ["luskctl.lib.util.fs"]

# Port allocation interface
[[interfaces]]
expose = ["assign_web_port"]
from = ["luskctl.lib.containers.ports"]

# Core path resolution interface
[[interfaces]]
expose = ["config_root", "state_root", "runtime_root"]
from = ["luskctl.lib.core.paths"]

# Core version interface
[[interfaces]]
expose = ["get_version_info", "format_version_string"]
from = ["luskctl.lib.core.version"]
